# CloudLunacy Agent Integration Process - Flow Diagram

The following diagram illustrates the complete flow for integrating a CloudLunacy agent with the front server.

```mermaid
sequenceDiagram
    participant A as CloudLunacy Agent
    participant F as Front Server
    participant H as HAProxy (Data Plane API)

    Note over A,H: Step 1: Agent Registration
    A->>F: POST /api/agents/register<br/>(agentId, agentKey, agentName, targetIp)
    F->>F: Validate and store agent details
    F-->>A: Registration success response

    Note over A,H: Step 2a: HTTP Route Setup
    A->>F: POST /api/proxy/http<br/>(agentId, subdomain, targetUrl, options)
    F->>H: Create HAProxy HTTP frontend/backend via Data Plane API
    H-->>F: HAProxy configuration success
    F-->>A: HTTP route created response

    Note over A,H: Step 2b: MongoDB Route Setup (Optional)
    A->>F: POST /api/proxy/mongodb<br/>(agentId, targetHost, targetPort, options)
    F->>F: Generate TLS certificates
    F->>H: Create HAProxy MongoDB frontend/backend via Data Plane API
    H-->>F: HAProxy configuration success
    F-->>A: MongoDB route created response

    Note over A,H: Step 3: Certificate Management
    A->>F: GET /api/config/{agentId}<br/>(with authentication)
    F-->>A: Return certificates (CA, cert, key)
    A->>A: Save certificates to filesystem
    A->>A: Configure MongoDB with TLS

    Note over A,H: Ongoing Operations
    A->>F: POST /api/agents/authenticate<br/>(for token renewal)
    F-->>A: Return new JWT token

    A->>F: GET /api/proxy/agents/{agentId}<br/>(list routes)
    F-->>A: Return all configured routes

    A->>F: DELETE /api/proxy<br/>(remove route)
    F->>H: Update HAProxy configuration via Data Plane API
    H-->>F: Configuration update success
    F-->>A: Route removed confirmation
```

## Key Points About Agent Integration

1. **Agent Registration**: Before any routes can be set up, the agent must register itself with the front server, establishing its identity.

2. **Route Setup**: The agent can set up different types of routes:

   - HTTP routes for web applications
   - MongoDB routes for database access

3. **Certificate Management**: For secure connections, the agent downloads and installs certificates generated by the front server.

4. **Authentication**: The agent authenticates with the front server to obtain a JWT token for subsequent operations.

5. **HAProxy Data Plane API**: All proxy configurations are managed by HAProxy's Data Plane API, providing a robust and efficient way to update routes without service interruptions.

The CloudLunacy Front Server handles all the complexity of certificate generation, HAProxy configuration, and route management, providing a simple API for agents to use.
